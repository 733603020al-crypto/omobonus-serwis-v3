#!/bin/sh

# Git post-commit hook ะดะปั ะฐะฒัะพะผะฐัะธัะตัะบะพะณะพ ะทะฐะฟััะบะฐ npm run dev
# ะัะพะฒะตััะตั, ะทะฐะฟััะตะฝ ะปะธ ัะถะต ัะตัะฒะตั, ะธ ะทะฐะฟััะบะฐะตั ะตะณะพ ะตัะปะธ ะฝะตั

# ะฆะฒะตัะฐ ะดะปั ะฒัะฒะพะดะฐ
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo ""
echo "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo "${YELLOW}๐ Git Hook: ะัะพะฒะตัะบะฐ ัะตัะฒะตัะฐ ัะฐะทัะฐะฑะพัะบะธ...${NC}"
echo "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

# ะะตัะตัะพะดะธะผ ะฒ ะบะพัะฝะตะฒัั ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT" || exit 1

# ะะฟัะตะดะตะปัะตะผ ะฟะปะฐััะพัะผั
UNAME_S=$(uname -s 2>/dev/null || echo "Unknown")
IS_WINDOWS=false

if echo "$UNAME_S" | grep -q "MINGW\|MSYS\|CYGWIN"; then
    IS_WINDOWS=true
fi

# ะคัะฝะบัะธั ะฟัะพะฒะตัะบะธ ะทะฐะฟััะตะฝะฝะพะณะพ ะฟัะพัะตััะฐ
check_node_running() {
    if [ "$IS_WINDOWS" = "true" ]; then
        # Windows: ะฟัะพะฒะตััะตะผ ัะตัะตะท tasklist ะธะปะธ wmic
        if command -v tasklist >/dev/null 2>&1; then
            tasklist //FI "IMAGENAME eq node.exe" 2>/dev/null | grep -qi "node.exe" && return 0
        fi
        # ะะปััะตัะฝะฐัะธะฒะฝัะน ัะฟะพัะพะฑ ัะตัะตะท wmic
        if command -v wmic >/dev/null 2>&1; then
            wmic process where "name='node.exe'" get name 2>/dev/null | grep -qi "node.exe" && return 0
        fi
        return 1
    else
        # Linux/Mac: ะฟัะพะฒะตััะตะผ ัะตัะตะท ps
        ps aux 2>/dev/null | grep -q "[n]ode.*dev" && return 0
        return 1
    fi
}

# ะัะพะฒะตััะตะผ, ะทะฐะฟััะตะฝ ะปะธ ัะถะต ัะตัะฒะตั ัะฐะทัะฐะฑะพัะบะธ
if check_node_running; then
    echo "${GREEN}โ ะกะตัะฒะตั ัะฐะทัะฐะฑะพัะบะธ ัะถะต ะทะฐะฟััะตะฝ${NC}"
    echo "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
    echo ""
    exit 0
fi

echo "${YELLOW}๐ ะกะตัะฒะตั ะฝะต ะทะฐะฟััะตะฝ. ะะฐะฟััะบะฐั npm run dev...${NC}"

# ะะฐะฟััะบะฐะตะผ npm run dev ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต
if [ "$IS_WINDOWS" = "true" ]; then
    # Windows: ะธัะฟะพะปัะทัะตะผ start ะดะปั ะทะฐะฟััะบะฐ ะฒ ะฝะพะฒะพะผ ะพะบะฝะต ะธะปะธ nohup
    # ะัะพะฑัะตะผ ะทะฐะฟัััะธัั ัะตัะตะท cmd ะฒ ัะพะฝะต
    if command -v cmd >/dev/null 2>&1; then
        # ะะฐะฟััะบะฐะตะผ ัะตัะตะท cmd ะฒ ัะพะฝะพะฒะพะผ ัะตะถะธะผะต
        cmd //c "start /B npm run dev" >nul 2>&1 &
    else
        # Fallback: ะธัะฟะพะปัะทัะตะผ nohup ะตัะปะธ ะดะพัััะฟะตะฝ
        nohup npm run dev > /dev/null 2>&1 &
    fi
else
    # Linux/Mac: ะธัะฟะพะปัะทัะตะผ nohup
    nohup npm run dev > /dev/null 2>&1 &
fi

# ะกะพััะฐะฝัะตะผ PID ะฟัะพัะตััะฐ
DEV_PID=$!

# ะะตะฑะพะปััะฐั ะทะฐะดะตัะถะบะฐ ะดะปั ะฟัะพะฒะตัะบะธ ะทะฐะฟััะบะฐ
sleep 3

# ะัะพะฒะตััะตะผ, ะทะฐะฟัััะธะปัั ะปะธ ะฟัะพัะตัั
if check_node_running; then
    echo "${GREEN}โ ะกะตัะฒะตั ัะฐะทัะฐะฑะพัะบะธ ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ (PID: $DEV_PID)${NC}"
    echo "${GREEN}๐ก ะกะตัะฒะตั ะดะพัััะฟะตะฝ ะฝะฐ http://localhost:3000${NC}"
    echo "${GREEN}๐ก ะะปะธ ะฝะฐ http://localhost:3001 (ะตัะปะธ 3000 ะทะฐะฝัั)${NC}"
else
    echo "${YELLOW}โ๏ธ  ะะต ัะดะฐะปะพัั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะฟัััะธัั ัะตัะฒะตั${NC}"
    echo "${YELLOW}๐ก ะะฐะฟัััะธัะต ะฒัััะฝัั: npm run dev${NC}"
fi

echo "${BLUE}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo ""

exit 0

